---
layout: single
title: "【生产力】Total Commander + PowerShell：一键智能批量重命名美剧字幕 (完美支持NAS网络路径)"
date: 2025-11-13T23:07:52categories: ITtags: 
---
## 背景痛点

作为美剧爱好者和 Total Commander (TC) 的重度用户，我经常遇到这样的情况： 下载了一整季的美剧（比如《猎魔人》），视频文件名是规范的 `S04E01` 格式，但下载的字幕文件通常名字乱七八糟，或者带有各种后缀。

如果直接按列表顺序批量重命名，一旦视频和字幕的排序不一致（比如一个按时间排，一个按名字排），就会导致**字幕张冠李戴** 。

我需要的是一个**智能方案** ：

  1. **正则匹配** ：自动识别视频和字幕中的 `SxxExx`（季数+集数）编号进行匹配，而不是傻傻地按顺序改名。
  2. **一键操作** ：在 TC 里点击一个按钮瞬间完成。
  3. **支持 NAS** ：必须能直接在网络共享路径（SMB/UNC路径）下工作，不需要映射盘符。



经过反复调试（踩了不少坑），终于用 PowerShell 完美解决了这个问题。

### 解决方案：SmartRename.ps1 脚本

这个脚本会自动扫描当前目录下的视频和字幕，提取 `SxxExx` 进行配对，并将字幕重命名为与视频同名（保留字幕后缀）。

#### 1\. 创建脚本

在你的电脑任意位置（例如 `D:\Tools\Scripts\`）新建一个文本文件，重命名为 `SmartRename.ps1`，复制以下代码：

PowerShell
    
    
    <#
    脚本功能：自动匹配当前目录下的视频和字幕（基于 SxxExx 编号），并将字幕重命名为视频同名。
    特点：支持 NAS 网络路径 (UNC)，解决 TC 传参末尾反斜杠 BUG。
    #>
    
    # 接收 TC 传过来的路径参数
    param([string]$TargetDir)
    
    # --- 核心修正：解决 TC 路径传参 BUG ---
    # Total Commander 的 %P 变量末尾带反斜杠，导致传参时会转义引号。
    # 我们在 TC 参数里人为加了一个空格，这里需要用 Trim() 去掉。
    if ($TargetDir) { 
        $TargetDir = $TargetDir.Trim()
    }
    
    # 设置控制台编码为 UTF8，防止中文乱码
    [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
    
    # --- 路径跳转：支持本地及网络路径 ---
    if ($TargetDir) {
        Write-Host "正在跳转至: [$TargetDir]" -ForegroundColor DarkGray
        
        # 使用 Push-Location 而非 Set-Location，以完美支持 UNC 网络路径
        try {
            Push-Location -LiteralPath $TargetDir -ErrorAction Stop
        }
        catch {
            Write-Host "错误：无法进入目录，请检查网络连接或权限！" -ForegroundColor Red
            Write-Host "详情: $($_.Exception.Message)" -ForegroundColor Red
            Read-Host "按回车键退出..."
            exit
        }
    }
    
    Write-Host "工作目录: $PWD" -ForegroundColor Magenta
    
    # --- 扫描文件 ---
    # 获取视频 (根据需要添加格式)
    $videos = Get-ChildItem -File | Where-Object { $_.Extension -match "\.(mkv|mp4|avi)" }
    # 获取字幕 (根据需要添加格式)
    $subs = Get-ChildItem -File | Where-Object { $_.Extension -match "\.(ass|srt|ssa|vtt)" }
    
    Write-Host "找到视频: $($videos.Count) 个" -ForegroundColor Cyan
    Write-Host "找到字幕: $($subs.Count) 个" -ForegroundColor Cyan
    
    if ($videos.Count -eq 0) {
        Write-Host "未找到视频文件。" -ForegroundColor Yellow
    } else {
        Write-Host "正在进行正则匹配 (SxxExx)..." -ForegroundColor Yellow
    }
    
    # --- 开始匹配和重命名 ---
    foreach ($video in $videos) {
        # 正则提取 SxxExx (不区分大小写)
        if ($video.Name -match "(?i)(S\d+E\d+)") {
            $episodeCode = $matches[1]
            
            # 查找包含相同编号的字幕
            $targetSub = $subs | Where-Object { $_.Name -match "(?i)$episodeCode" }
    
            # 如果找到字幕，且名字还未统一
            if ($targetSub -and ($targetSub.BaseName -ne $video.BaseName)) {
                $newSubName = $video.BaseName + $targetSub.Extension
                
                Write-Host "匹配成功: [$episodeCode]" -ForegroundColor Green
                Write-Host "  视频: $($video.Name)"
                Write-Host "  字幕: $($targetSub.Name)"
                
                try {
                    Rename-Item -Path $targetSub.FullName -NewName $newSubName -ErrorAction Stop
                    Write-Host "  [OK] 重命名完成" -ForegroundColor Green
                }
                catch {
                    Write-Host "  [ERROR] 失败: $($_.Exception.Message)" -ForegroundColor Red
                }
                Write-Host "--------------------------------"
            }
        }
    }
    
    Write-Host "处理完成，按回车键退出..." -ForegroundColor Yellow
    Read-Host
    

### Total Commander 设置（关键步骤）

这是最容易出错的地方。如果你只填 `%P`，脚本在处理带空格的路径或网络路径时会失效。

  1. 在 TC 工具栏 **右键** -> **更改** -> **添加** 。
  2. 按照下图填写配置：


  * **命令(C):** `powershell`
  * **参数(P):** Plaintext`-NoExit -ExecutionPolicy Bypass -File "D:\Tools\Scripts\SmartRename.ps1" "%P " `**⚠️ 注意高能预警：** 请仔细看上面参数的最后部分 `"%P "` —— **`%P` 的后面必须有一个空格！****原理解释：** TC 的 `%P` 变量输出的路径末尾自带一个反斜杠 `\`（例如 `D:\Movie\`）。如果直接写 `"%P"`，这在 Windows 命令行里会被解析为 `D:\Movie"`（反斜杠转义了引号），导致参数传递失败。加一个空格变成 `"%P "`，就变成了 `D:\Movie\ "`，引号就能正常闭合了。脚本里使用了 `.Trim()` 来处理这个多余的空格。
  * **起始路径(S):** 留空 (不需要填)
  * **图标文件(E):** 建议选个显眼的图标。



### 使用效果

设置好后，进入 NAS 里的美剧文件夹，点击按钮：

  1. 脚本会自动弹出黑框。
  2. 自动跳转到 NAS 路径（显示 `Push-Location` 成功）。
  3. 自动识别 `S01E01` 这种编号。
  4. 瞬间把乱七八糟的字幕改成和视频完全一致的文件名。



哪怕你的字幕列表是倒序的，视频是正序的，它也能精准匹配，绝不出错。

* * *

希望这个小工具能帮到同样喜欢折腾 NAS 和整理媒体库的朋友！
